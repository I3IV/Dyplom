import React, { Component, Fragment } from "react";
import { BrowserRouter as Router, Route } from "react-router-dom";
import { MuiThemeProvider } from "@material-ui/core/styles";
import "./app.css";
import muiTheme from "./muiTheme";
import MainPage from "../components-illia/pages/main-page";
import RegistrationPage from "../components-illia/pages/registration-page";
import LoginPage from "../components-illia/pages/login-page";
import AccountPage from "../components-illia/pages/account-page";
import RestaurantsPage from "components/pages/restaurants-page";
import RestaurantPage from "components-vitalii/pages/restaurant-page";
import DishesPage from "components/pages/dishes-page";
import CheckoutPage from "components/pages/checkout-page";
import ScheduleItems from "components/pages/schedule-items-page";
import PrivateRoute from "shared-components/private-route";
import client from "feathers/client";
import Spinner from "shared-components/spinner";
import DevTools from "mobx-react-devtools";
import { authStore } from "store";
import {
  getLoggedInUser,
  initRestaurantsStore,
  initCalendarStore,
  initCitiesStore,
  initProductsStore
} from "api";

export default class App extends Component {
  state = {
    loading: true
  };

  componentWillMount() {
    console.log("COMPONENT WILL MOUNT");
    this.setState({ loading: true });

    getLoggedInUser()
      .then(user => {
        authStore.authenticate(user);
        initCalendarStore();
      })
      .catch(() => {
        authStore.authenticate(false);
      });
    initCitiesStore()
      .then(() => initRestaurantsStore())
      .then(() => initProductsStore())
      .then(() => {
        this.setState({ loading: false });
      });
  }

  render() {
    client.on("logout", () => {
      console.log("LOGGING OUT");
      this.forceUpdate();
      authStore.authenticate(false);
    });
    if (this.state.loading) return <Spinner />;
    return (
      <Router>
        <Fragment>
          <DevTools />
          <MuiThemeProvider theme={muiTheme}>
            <Route path="/" component={MainPage} exact />
            <Route path="/login" component={LoginPage} />
            <Route path="/registration" component={RegistrationPage} />
            <PrivateRoute path="/account" component={AccountPage} />
            <Route path="/restaurants/:id" component={RestaurantPage} />
          </MuiThemeProvider>
          <Route exact path="/restaurants" component={RestaurantsPage} />
          <Route path="/dishes" component={DishesPage} />
          <Route path="/checkout" component={CheckoutPage} />
          <PrivateRoute path="/scheduler" component={ScheduleItems} />
        </Fragment>
      </Router>
    );
  }
}
